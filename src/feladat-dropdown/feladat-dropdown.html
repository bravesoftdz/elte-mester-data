<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/paper-dropdown-input/paper-dropdown-input.html">

<dom-module id="feladat-dropdown">
    <template>
        <style>
            paper-dropdown-input {
                color: var(--paper-red-900);
            }

            paper-ripple {
                color: var(--paper-green-500);
            }

            /*noinspection CssUnusedSymbol*/
            paper-dropdown-input.loaded {
                color: initial;
            }

            :host {
                display: inline-block;
                position: relative;
            }
        </style>
        <paper-ripple id="ripple" noink></paper-ripple>
        <paper-dropdown-input label="Feladat" items="[[items]]" filter-property="title"
                              selected-item="{{selection}}" id="dropdown">
            <template>
                <template is="dom-repeat" items="[[items]]">
                    <template is="if" if="[[item.new]]">
                        <hr disabled>
                    </template>
                    <paper-item style$="[[item.style]]" data="[[item]]">[[item.title]]</paper-item>
                </template>
            </template>
        </paper-dropdown-input>
    </template>
    <!--suppress JSUnusedGlobalSymbols, JSUnresolvedVariable -->
    <script>
        class FeladatDropdown extends Polymer.Element {
            static get is() {
                return 'feladat-dropdown';
            }

            static get properties() {
                return {
                    temaList: {
                        type: Array
                    },
                    items: {
                        type: Array,
                        notify: true
                        //, readOnly: true
                    },
                    selection: {
                        type: Object,
                        notify: true,
                        //readOnly: true,
                        value: undefined
                    }
                };
            }

            static get observers() {
                return [
                    '_temaListChanged(temaList)',
                    '_temaAddedOrRemoved(temaList.slices)'
                ];
            }

            _temaListChanged(temaList) {
                if (this.items) this.items.obsolete = false;
                this.$.dropdown.classList.remove("loaded");
                this.set('items', []);
                const itemsRef = this.items;
                if (temaList) {
                    Promise.all(temaList.map(tema =>
                        tema.fetchFeladatList.run(this).then(value => {
                            if (itemsRef.obsolete) {
                                throw new Error("Items are obsolete");
                            } else {
                                return value;
                            }
                        }).then(feladatList => {
                            this.push('items', {
                                title: tema.name,
                                object: tema,
                                feladat: tema.mintafeladat,
                                tema: tema,
                                style: "font-weight: lighter;",
                                new: temaList.length > 1
                            }, ...feladatList.map(feladat => ({
                                title: feladat.name,
                                object: feladat,
                                feladat: feladat,
                                tema: tema
                            })));

                            //TODO Why is it needed?
                            {
                                let itemsBackup = this.items;
                                this.set('items', []);
                                this.set('items', itemsBackup);
                            }
                        })
                    )).then(() => {
                        if (itemsRef.obsolete) {
                            throw new Error("Items are obsolete");
                        } else {
                            this.$.dropdown.classList.add("loaded");
                            this.$.ripple.simulatedRipple();
                        }
                    });
                }
            }

            _temaAddedOrRemoved(slices) {
                //TODO handle this
            }
        }

        customElements.define(FeladatDropdown.is, FeladatDropdown);
    </script>
</dom-module>